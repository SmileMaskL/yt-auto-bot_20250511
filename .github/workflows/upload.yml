# GitHub Actions 자동화 설정
name: 🤖 YouTube Video Automation

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:  # 수동 실행 트리거

jobs:
  upload-video:
    runs-on: ubuntu-latest

    steps:
      - name: 🔄 Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 전체 커밋 히스토리 가져오기

      - name: 🐍 Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: ✅ 시스템 종속성 설치
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            ffmpeg \
            libsm6 \
            libxext6 \
            libfontconfig1

      - name: ✅ 폰트 파일 검증
        run: |
          echo "===== 폰트 경로 검증 ====="
          FONT_PATH="fonts/NotoSansCJKkr-Regular.otf"
          if [ ! -f "$FONT_PATH" ]; then
            echo "::error::❌ 필수 폰트 파일이 존재하지 않습니다: $FONT_PATH"
            exit 1
          else
            echo "✅ 폰트 파일 확인: $(realpath $FONT_PATH)"
          fi

      - name: ✅ 환경변수 설정
        run: |
          echo "OPENAI_API_KEYS_BASE64=${{ secrets.OPENAI_API_KEYS_BASE64 }}" >> $GITHUB_ENV
          echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> $GITHUB_ENV
          echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> $GITHUB_ENV
          echo "GOOGLE_REFRESH_TOKEN=${{ secrets.GOOGLE_REFRESH_TOKEN }}" >> $GITHUB_ENV
          echo "ELEVENLABS_KEY=${{ secrets.ELEVENLABS_KEY }}" >> $GITHUB_ENV
          echo "ELEVENLABS_VOICE_ID=${{ secrets.ELEVENLABS_VOICE_ID }}" >> $GITHUB_ENV
          echo "SLACK_API_TOKEN=${{ secrets.SLACK_API_TOKEN }}" >> $GITHUB_ENV
          echo "SLACK_CHANNEL=${{ secrets.SLACK_CHANNEL }}" >> $GITHUB_ENV

      - name: 🛠️ Python 종속성 설치
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 🚀 메인 스크립트 실행
        run: python scripts/main.py
