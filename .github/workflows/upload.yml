name: ü§ñ YouTube Video Automation

on:
  schedule:
    - cron: '0 */6 * * *' # Runs every 6 hours
  workflow_dispatch:      # Allows manual triggering from the Actions tab

jobs:
  upload-video:
    runs-on: ubuntu-22.04 # Using a more recent LTS version

    env: # Define environment variables from secrets for the whole job
      OPENAI_API_KEYS_BASE64: ${{ secrets.OPENAI_API_KEYS_BASE64 }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
      SLACK_API_TOKEN: ${{ secrets.SLACK_API_TOKEN }}
      SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}
      # Add any other necessary environment variables here (e.g., ELEVENLABS_KEY if you use it)

    steps:
      - name: üîÑ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for some git operations if any

      # FFmpeg ÏÑ§Ïπò: ÏïàÏ†ïÏ†ÅÏù¥Í≥† ÏµúÏã† Î≤ÑÏ†Ñ (Stable Static Build)
      - name: üõ†Ô∏è Install FFmpeg (Stable Static Build)
        run: |
          # FFmpeg ÏµúÏã† ÏïàÏ†ï Î≤ÑÏ†Ñ Îã§Ïö¥Î°úÎìú Î∞è ÏÑ§Ïπò
          curl -L https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-i686-static.tar.xz -o ffmpeg.tar.xz
          tar -xf ffmpeg.tar.xz
          sudo cp ffmpeg-*-amd64-static/ffmpeg /usr/bin/ffmpeg
          sudo chmod +x /usr/bin/ffmpeg
          # ÏÑ§Ïπò ÌõÑ ffmpeg Î≤ÑÏ†Ñ ÌôïÏù∏
          ffmpeg -version
          
          # FFmpeg ÏÑ§Ïπò ÌôïÏù∏ Î∞è Î≤ÑÏ†Ñ Ï≤¥ÌÅ¨
          FFMPEG_VERSION_FULL=$(ffmpeg -version)
          echo "Full FFmpeg version output:"
          echo "$FFMPEG_VERSION_FULL"
          
          FFMPEG_VERSION=$(echo "$FFMPEG_VERSION_FULL" | grep -oP 'ffmpeg version \K[^ ]+' | cut -d'.' -f1)
          if [ -z "$FFMPEG_VERSION" ] || [ "$FFMPEG_VERSION" -lt 6 ]; then
            echo "::error::‚ùå FFmpeg 6.0+ installation check failed. Detected major version: $FFMPEG_VERSION. Full output above."
            exit 1
          fi
          echo "‚úÖ FFmpeg major version $FFMPEG_VERSION installed successfully."

      - name: üêç Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: üì¶ Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt --no-cache-dir
          else
            echo "::error::‚ùå requirements.txt not found!"
            exit 1
          fi
          # Verify moviepy can find ffmpeg (optional, but good for debugging)
          python -c "from moviepy.config import get_setting; print(f'MoviePy FFmpeg path: {get_setting("FFMPEG_BINARY")}')"

      - name: ‚úÖ Verify Essential Files
        run: |
          FONT_PATH="fonts/NotoSansCJKkr-Regular.otf"
          if [ ! -f "$FONT_PATH" ]; then
            echo "::error::‚ùå Required font file not found: $FONT_PATH"
            exit 1
          else
            echo "‚úÖ Font file verified: $(realpath $FONT_PATH)"
          fi

          BACKGROUND_PATH="background.jpg"
          if [ ! -f "$BACKGROUND_PATH" ]; then
            echo "::warning::‚ö†Ô∏è Background image not found: $BACKGROUND_PATH. Script might use a default color."
            # Depending on script logic, this might not be a fatal error.
            # If it's fatal, change to ::error:: and exit 1.
          else
            echo "‚úÖ Background image verified: $(realpath $BACKGROUND_PATH)"
          fi

      - name: üõ°Ô∏è Validate Environment Variables & Configuration
        run: python scripts/validate_env.py # This script will use os.getenv

      - name: üöÄ Run Main Automation Script
        run: python scripts/main.py

      # Optional: Upload logs as artifacts for debugging
      - name: üì§ Upload Logs
        if: always() # Run this step even if previous steps fail
        uses: actions/upload-artifact@v4
        with:
          name: automation-logs
          path: |
            *.log
            scripts/*.log
          retention-days: 7
