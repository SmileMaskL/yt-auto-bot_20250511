# GitHub Actions ìë™í™” ì„¤ì •
name: ğŸ“¤ YouTube Upload Automation

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # 6ì‹œê°„ ê°„ê²© ì‹¤í–‰

jobs:
  build:
    timeout-minutes: 45
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ•’ íƒ€ì„ì¡´ ì„¤ì •
      run: |
        sudo timedatectl set-timezone Asia/Seoul
        echo "í˜„ì¬ ì‹œê°„: $(date +'%Y-%m-%d %H:%M:%S %Z')"

    - name: âœ… ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: âœ… Python 3.10 ì„¤ì¹˜
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ”’ ë³´ì•ˆ í‚¤ ê²€ì¦
      run: |
        echo "===== API í‚¤ ì‚¬ì „ ê²€ì¦ ====="
        python -c "import base64,json,os;keys=json.loads(base64.b64decode(os.getenv('OPENAI_API_KEYS_BASE64')).decode());print(f'ğŸ”‘ ë¡œë“œëœ OpenAI í‚¤ ìˆ˜: {len(keys)}')"

    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements.txt

    - name: ğŸ› ï¸ ë¯¸ë””ì–´ ë„êµ¬ ì„¤ì¹˜
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg libfontconfig1

    - name: âš™ï¸ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
      run: |
        echo "OPENAI_API_KEYS_BASE64=${{ secrets.OPENAI_API_KEYS_BASE64 }}" >> $GITHUB_ENV
        echo "ELEVENLABS_KEY=${{ secrets.ELEVENLABS_KEY }}" >> $GITHUB_ENV
        echo "ELEVENLABS_VOICE_ID=${{ secrets.ELEVENLABS_VOICE_ID }}" >> $GITHUB_ENV
        echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> $GITHUB_ENV
        echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> $GITHUB_ENV
        echo "GOOGLE_REFRESH_TOKEN=${{ secrets.GOOGLE_REFRESH_TOKEN }}" >> $GITHUB_ENV
        echo "SLACK_API_TOKEN=${{ secrets.SLACK_API_TOKEN }}" >> $GITHUB_ENV
        echo "SLACK_CHANNEL=${{ secrets.SLACK_CHANNEL }}" >> $GITHUB_ENV

    - name: â–¶ï¸ ë©”ì¸ ì‹¤í–‰
      run: |
        PYTHONPATH=${{ github.workspace }} python scripts/main.py

    - name: ğŸ“Š ì‹¤í–‰ ë¡œê·¸
      if: always()
      run: |
        echo "===== ì‹œìŠ¤í…œ ì§„ë‹¨ ë¦¬í¬íŠ¸ ====="
        echo "ìµœê·¼ ì˜¤ë¥˜:"
        grep "âŒ" automation.log | tail -n 5 || true
        echo "\ní‚¤ ì‚¬ìš© í˜„í™©:"
        grep "ğŸ”‘" automation.log | tail -n 3 || true

    - name: ğŸ—„ï¸ ë¡œê·¸ ê´€ë¦¬
      if: always()
      run: |
        mkdir -p logs
        find . -name "*.log" -mtime +6 -exec zip -j "logs/archive_$(date +%Y%m%d).zip" {} +
        find . -name "*.log" -mtime +6 -delete
