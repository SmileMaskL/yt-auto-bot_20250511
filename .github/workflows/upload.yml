# GitHub Actions ìë™í™” ì„¤ì •
name: ğŸ¤– YouTube Video Automation

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ íŠ¸ë¦¬ê±°

jobs:
  upload-video:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: âœ… í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          echo "OPENAI_API_KEYS_BASE64=${{ secrets.OPENAI_API_KEYS_BASE64 }}" >> $GITHUB_ENV
          echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> $GITHUB_ENV
          echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> $GITHUB_ENV
          echo "GOOGLE_REFRESH_TOKEN=${{ secrets.GOOGLE_REFRESH_TOKEN }}" >> $GITHUB_ENV
          echo "SLACK_API_TOKEN=${{ secrets.SLACK_API_TOKEN }}" >> $GITHUB_ENV
          echo "SLACK_CHANNEL=${{ secrets.SLACK_CHANNEL }}" >> $GITHUB_ENV
          echo "ELEVENLABS_KEY=${{ secrets.ELEVENLABS_KEY }}" >> $GITHUB_ENV
          echo "ELEVENLABS_VOICE_ID=${{ secrets.ELEVENLABS_VOICE_ID }}" >> $GITHUB_ENV
          
      - name: âœ… ì„¤ì¹˜ ì „ ì‹œìŠ¤í…œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—…ë°ì´íŠ¸
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ffmpeg

      - name: âœ… API í‚¤ ì‚¬ì „ ê²€ì¦
        run: |
          echo "===== API í‚¤ ì‚¬ì „ ê²€ì¦ ====="
          # í‚¤ê°€ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸ (ë‚´ìš© ë…¸ì¶œ ì—†ì´)
          if [ -z "${{ secrets.OPENAI_API_KEYS_BASE64 }}" ]; then
            echo "âŒ OPENAI_API_KEYS_BASE64 ì‹œí¬ë¦¿ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          else
            echo "âœ… OPENAI_API_KEYS_BASE64 ì‹œí¬ë¦¿ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
          fi
          
          # ì¶”ê°€ ë””ë²„ê¹… ìŠ¤í¬ë¦½íŠ¸
          echo "âœ… ì¶”ê°€ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰"
          python -c "
import os, base64, json, sys

# ì‹œí¬ë¦¿ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜
def check_secret(name):
    value = os.environ.get(name)
    if not value:
        print(f'âŒ {name} í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')
        return False
    print(f'âœ… {name} í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.')
    return True

# OpenAI API í‚¤ ê²€ì¦
openai_keys_b64 = os.environ.get('OPENAI_API_KEYS_BASE64')
if openai_keys_b64:
    try:
        # base64 ë””ì½”ë”© ì‹œë„
        decoded = base64.b64decode(openai_keys_b64).decode('utf-8')
        keys = json.loads(decoded)
        if isinstance(keys, list) and len(keys) > 0:
            print(f'âœ… ì´ {len(keys)}ê°œì˜ OpenAI API í‚¤ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.')
        else:
            print('âŒ OpenAI API í‚¤ ëª©ë¡ì´ ë¹„ì–´ìˆê±°ë‚˜ ì˜¬ë°”ë¥¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.')
    except Exception as e:
        print(f'âŒ OpenAI API í‚¤ ë””ì½”ë”© ì˜¤ë¥˜: {str(e)}')
        sys.exit(1)
        
# í•„ìˆ˜ ì‹œí¬ë¦¿ í™•ì¸
check_secret('GOOGLE_CLIENT_ID')
check_secret('GOOGLE_CLIENT_SECRET')
check_secret('GOOGLE_REFRESH_TOKEN')
check_secret('ELEVENLABS_KEY')
check_secret('ELEVENLABS_VOICE_ID')
"

      - name: ğŸ› ï¸ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸš€ Run Main Script
        run: python scripts/main.py
