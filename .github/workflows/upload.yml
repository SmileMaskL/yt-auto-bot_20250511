# GitHub Actions ìë™í™” ì„¤ì •
name: ğŸ¤– YouTube Video Automation

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ íŠ¸ë¦¬ê±°

jobs:
  upload-video:
    runs-on: ubuntu-20.04  # ëª…ì‹œì  OS ë²„ì „ ì§€ì •

    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ› ï¸ FFmpeg 6 ì„¤ì¹˜ (ìš°íšŒ ë°©ë²•)
        run: |
          # ê¸°ì¡´ FFmpeg ì œê±°
          sudo apt-get remove --purge ffmpeg* -y
          
          # PPA ëŒ€ì²´ ì„¤ì¹˜
          sudo add-apt-repository ppa:savoury1/ffmpeg6 -y
          sudo apt-get update -y
          sudo apt-get install -y \
            ffmpeg \
            libavcodec-extra \
            libsdl2-2.0-0

          # ë²„ì „ ê²€ì¦
          FFMPEG_VERSION=$(ffmpeg -version | grep "ffmpeg version" | cut -d' ' -f3)
          if [[ "$FFMPEG_VERSION" < "6.0" ]]; then
            echo "::error::âŒ FFmpeg 6.0+ ì„¤ì¹˜ ì‹¤íŒ¨ (í˜„ì¬: $FFMPEG_VERSION)"
            exit 1
          fi
          echo "âœ… FFmpeg $FFMPEG_VERSION ì„¤ì¹˜ ì™„ë£Œ"

      - name: âœ… í°íŠ¸ íŒŒì¼ ê²€ì¦
        run: |
          FONT_PATH="fonts/NotoSansCJKkr-Regular.otf"
          if [ ! -f "$FONT_PATH" ]; then
            echo "::error::âŒ í•„ìˆ˜ í°íŠ¸ íŒŒì¼ ëˆ„ë½: $FONT_PATH"
            exit 1
          else
            echo "âœ… í°íŠ¸ íŒŒì¼ í™•ì¸: $(realpath $FONT_PATH)"
          fi

      - name: âœ… í™˜ê²½ë³€ìˆ˜ ì‚¬ì „ ê²€ì¦
        run: |
          # Base64 ìœ íš¨ì„± ê²€ì‚¬
          if [ -z "${{ secrets.OPENAI_API_KEYS_BASE64 }}" ]; then
            echo "::error::ğŸš¨ OPENAI_API_KEYS_BASE64 ë¯¸ì„¤ì •"
            exit 1
          fi
          echo -n "${{ secrets.OPENAI_API_KEYS_BASE64 }}" | base64 -d > /dev/null || {
            echo "::error::ğŸš¨ Base64 ë””ì½”ë”© ì‹¤íŒ¨";
            exit 1;
          }

          # íŒŒì´ì¬ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          python scripts/validate_env.py

      - name: ğŸ Python 3.10 ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: ğŸ“¦ Python ì¢…ì†ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt --no-cache-dir

      - name: ğŸš€ ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        run: python scripts/main.py
