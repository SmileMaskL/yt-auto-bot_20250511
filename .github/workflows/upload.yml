# GitHub Actions 자동화 설정
name: 🤖 YouTube Video Automation

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  upload-video:
    runs-on: ubuntu-latest

    steps:
      - name: 🔄 Checkout Repository
        uses: actions/checkout@v3

      - name: ✅ 환경 변수 설정
        run: |
          echo "OPENAI_API_KEYS_BASE64=${{ secrets.OPENAI_API_KEYS_BASE64 }}" >> $GITHUB_ENV
          echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> $GITHUB_ENV
          echo "SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}" >> $GITHUB_ENV
          echo "ELEVENLABS_API_KEY=${{ secrets.ELEVENLABS_API_KEY }}" >> $GITHUB_ENV
          echo "YOUTUBE_REFRESH_TOKEN=${{ secrets.YOUTUBE_REFRESH_TOKEN }}" >> $GITHUB_ENV

      - name: ✅ API 키 사전 검증
        run: |
          echo "===== API 키 사전 검증 ====="
          if [ -z "${{ secrets.OPENAI_API_KEYS_BASE64 }}" ]; then
            echo "❌ OPENAI_API_KEYS_BASE64 시크릿이 설정되지 않았습니다."
            exit 1
          fi

          python -c "import os, base64, json
decoded = base64.b64decode(os.environ['OPENAI_API_KEYS_BASE64']).decode('utf-8')
keys = json.loads(decoded)
assert isinstance(keys, list) and keys, '❌ 유효한 키 리스트가 아닙니다.'
print(f'✅ 총 {len(keys)}개의 API 키가 로드되었습니다.')"

      - name: 🛠️ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 🚀 Run Main Script
        run: python scripts/main.py
