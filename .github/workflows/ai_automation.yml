name: ğŸ¤– AI Video Factory 3.2 Ultra

on:
  schedule:
    - cron: '0 */4 * * *'  # 4ì‹œê°„ ì£¼ê¸° ì‹¤í–‰
  workflow_dispatch:
    inputs:
      topic:
        description: 'ì½˜í…ì¸  ì£¼ì œ'
        required: true
      quality:
        description: 'í•´ìƒë„ (720p/1080p/4K)'
        default: '1080p'
      emergency_mode:
        description: "ê¸´ê¸‰ ëª¨ë“œ í™œì„±í™” (true/false)"
        default: 'false'

env:
  TZ: Asia/Seoul
  PYTHON_VERSION: '3.10.12'
  CACHE_VERSION: 'v25.05.14'

jobs:
  video-production:
    name: ğŸ¬ AI ë¹„ë””ì˜¤ ë©”ê°€íŒ©í† ë¦¬
    runs-on: ubuntu-22.04
    timeout-minutes: 55

    steps:
    # ===== [1ë‹¨ê³„] ì½”ì–´ ì„¤ì • =====
    - name: ğŸ”„ ì €ì¥ì†Œ í´ë¡  (ì „ì²´ íˆìŠ¤í† ë¦¬)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ” ë³´ì•ˆ ê²€ì¦
      run: |
        # í°íŠ¸/ìì› ê²€ì¦
        [ ! -f "fonts/NotoSansCJKkr-Regular.otf" ] && echo "::error::âŒ í°íŠ¸ íŒŒì¼ ëˆ„ë½" && exit 1
        echo "âœ… í•„ìˆ˜ ìì› ê²€ì¦ ì™„ë£Œ"

    # ===== [2ë‹¨ê³„] í™˜ê²½ êµ¬ì„± =====
    - name: ğŸ› ï¸ í™˜ê²½ë³€ìˆ˜ ì¸ì ì…˜
      env:
        ELEVENLABS_KEY: ${{ secrets.ELEVENLABS_KEY }}
        ELEVENLABS_VOICE_ID: ${{ secrets.ELEVENLABS_VOICE_ID }}
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
        OPENAI_API_KEYS_BASE64: ${{ secrets.OPENAI_API_KEYS_BASE64 }}
        SLACK_API_TOKEN: ${{ secrets.SLACK_API_TOKEN }}
        SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}
      run: |
        # .env íŒŒì¼ ìƒì„±
        echo "ELEVENLABS_KEY=$ELEVENLABS_KEY" >> .env
        echo "ELEVENLABS_VOICE_ID=$ELEVENLABS_VOICE_ID" >> .env
        echo "SLACK_API_TOKEN=$SLACK_API_TOKEN" >> .env
        echo "SLACK_CHANNEL=$SLACK_CHANNEL" >> .env
        echo "OPENAI_API_KEYS=$OPENAI_API_KEYS_BASE64" >> .env

        # Google í† í° ìƒì„±
        echo '{
          "client_id": "$GOOGLE_CLIENT_ID",
          "client_secret": "$GOOGLE_CLIENT_SECRET",
          "refresh_token": "$GOOGLE_REFRESH_TOKEN"
        }' | envsubst > token.json

        # ë³´ì•ˆ ê²€ì¦
        python -c "import base64, json; \
          assert len(json.loads(base64.b64decode('$OPENAI_API_KEYS_BASE64'))) >= 2, 'OpenAI í‚¤ ë¶€ì¡±'"

    # ===== [3ë‹¨ê³„] íŒŒì´ì¬ í™˜ê²½ =====
    - name: ğŸ Python ${{ env.PYTHON_VERSION }} êµ¬ì„±
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'

    - name: ğŸ“¦ ê³ ì„±ëŠ¥ íŒ¨í‚¤ì§€ ì„¤ì¹˜
      run: |
        pip install torch==2.3.0+cu121 \
          --extra-index-url https://download.pytorch.org/whl/cu121 \
          --no-cache-dir
        pip install -r requirements.txt \
          --extra-index-url https://download.pytorch.org/whl/cu121

    # ===== [4ë‹¨ê³„] AI ì—”ì§„ ì‹¤í–‰ =====
    - name: ğŸš€ ë©€í‹°ëª¨ë‹¬ AI íŒŒì´í”„ë¼ì¸
      env:
        FFMPEG_PATH: /usr/bin/ffmpeg
      run: |
        for attempt in {1..5}; do
          python scripts/main.py \
            --topic "${{ inputs.topic }}" \
            --quality ${{ inputs.quality }} \
            --emergency ${{ inputs.emergency_mode }} \
            --attempt $attempt && break
        done

    # ===== [5ë‹¨ê³„] ê²°ê³¼ ê´€ë¦¬ =====
    - name: ğŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: ai-video-output
        path: |
          outputs/*.mp4
          outputs/*.log

    - name: ğŸš¨ 3ë‹¨ê³„ ì˜¤ë¥˜ ì•Œë¦¼
      if: failure()
      run: |
        python scripts/notifier.py \
          --status FAIL \
          --log automation.log \
          --slack-token ${{ secrets.SLACK_API_TOKEN }} \
          --channel ${{ secrets.SLACK_CHANNEL }}
